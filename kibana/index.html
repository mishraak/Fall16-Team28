<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Scatterplots</title> 
  <!--link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="/resources/demos/style.css"-->
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://cdn.jsdelivr.net/momentjs/2.16.0/moment-with-locales.min.js"></script>
  
  <script>

    var url;
    var chartData = [];

    Highcharts.setOptions({
        global: {
            useUTC: true
        }
    });


    $( document ).ready(function() {

        $("#datepickerFrom").datepicker({dateFormat: "mm-dd-yy"});
        $("#datepickerTo").datepicker({dateFormat: "mm-dd-yy"});

        var today = new Date();
        var last_week = today.setDate(today.getDate() - 7);

        $("#datepickerFrom").datepicker( 'setDate', today );
        $("#datepickerTo").datepicker( 'setDate', last_week );

        $('select option[value="*"]').attr("selected",true);

        $("#dropdown_change").change(function(){
              //console.log("New URL selected : " + document.getElementById("dropdown_change").value);
              url = document.getElementById("dropdown_change").value;
        });

        $("#btnSubmit").click(function(){
            var dateFrom = $("#datepickerFrom").datepicker('getDate');
            var fromDate = dateFrom.getTime();
            //console.log("dateFrom :" + dateFrom);


            var dateTo = $("#datepickerTo").datepicker('getDate');
            var toDate = dateTo.getTime();
            //console.log("dateTo :" + dateTo);

            url = document.getElementById("dropdown_change").value;
            //console.log(url);

            if (url == "*") {
              //console.log("url is *");
            }
            else
            {
              url = "/" + url;
              //console.log("url is " +url);
            }
            requestJSON = { 
                              "query" : 
                                {
                                  "bool" : {
                                        "should": [
                                            {
                                                "query_string": { 
                                                                  "query": "uriStem : " + url
                                                                  //"query" : "method:POST"         
                                                }
                                            } 
                                        ]
                                      }
                                }
                          }  


            
          console.log(JSON.stringify(requestJSON));

          $.ajax({
              type             : 'POST',
              url              : 'http://127.0.0.1:9200/cmpe272/_search?_source=log_timestamp,timetaken',
              dataType         : 'json',
              data             : JSON.stringify(requestJSON),
              success          : function(data) {
                                  console.log(data);
                                    parseData(data);
                                 },
              error            : function(e) { 
                                  console.log(e); 
                                },
              responseJSON     : function(responseText) {
                                  console.log(responseText);
                                }
    
          });                 

            
         }); 
        
    });



    function parseData(data) {
        $.each(data.hits.hits, function(index,item) {
            var chartDataSinglePoint = [];

            var log_date = new Date(item._source.log_timestamp)
            var d = log_date.getDate();
            var m = log_date.getMonth();
            var y = log_date.getFullYear();
            var h = log_date.getHours();
            var mn = log_date.getMinutes();
            var s = log_date.getSeconds();
            var dt = Date.UTC(y,m,d,h,mn,s);
            var timetaken = Number(item._source.timetaken[0]);

            chartDataSinglePoint.push(dt, timetaken);
            //console.log(chartDataSinglePoint);
            chartData.push(chartDataSinglePoint);
          });
          //console.log(chartData);
            ScatterplotData(chartData);
      };

function ScatterplotData(data) {    
      $(function () {
          $('#container').highcharts({
            chart: {
                type: 'scatter',
                zoomType: 'xy'
            },
            title: {
              text: 'Request timestamp vs time taken',
            },
            xAxis: {
              type: 'datetime',
              labels: {
                  formatter: function() {
                      //console.log(this);
                      return moment(this.value).format("YYYY-MM-DD");
                  }
              },
              title: {
                    text: 'Request timestamp'
                }
            },
            yAxis: {
                title: {
                    text: 'Load time (ms)'
                }
            },
            tooltip: {
                formatter: function() {
                    //console.log(this.x + " " + this.y);
                    return  '<b>' + this.series.name +'</b><br/>' +
                        Highcharts.dateFormat('%e - %b - %Y', new Date(this.x)) 
                        //this.x
                    + ' date, ' + this.y + ' (ms)';
                }
            },
            plotOptions: {
                scatter: {
                    marker: {
                        radius: 5,
                        states: {
                            hover: {
                                enabled: true,
                                lineColor: 'rgb(100,100,100)'
                            }
                        }
                    },
                    states: {
                        hover: {
                            marker: {
                                enabled: false
                            }
                        }
                    }     
                }
            },
            series: [{
              name: 'IIS Page Load Performance',
              data : data
            }]
          });
        });
    };

  </script>
</head>

<body>
  <p>
    From: <input type="datetime" id="datepickerFrom" autofocus>
    To: <input type="datetime" id="datepickerTo">
    
    Select a URL:
    <select id="dropdown_change">
      <option value="*">all</option>
      <option value="/index.htm<">index</option>
      <option value="/blank.htm">blank</option>
      <option value="/test.htm">test</option>
      <option value="/default.htm">default</option>
    </select>



    <input type="submit" value="Submit" id="btnSubmit">
  </p>
 
   <div id="container" style="min-width: 310px; height: 400px; max-width: 800px; margin: 0 auto"></div>
</body>